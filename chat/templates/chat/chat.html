{% extends "base.html" %}
{% load static %}
{% load tz %}

{# ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Django messages ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ base ‡∏°‡∏µ block messages ‡πÅ‡∏•‡πâ‡∏ß) #}
{% block messages %}{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f5f6f7 !important;
  }

  .chat-wrapper {
    max-width: 960px;
    margin: 0 auto;
    height: calc(100vh - 70px);
    background-color: #ffffff;
    border-radius: 24px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .chat-header {
    padding: 0.8rem 1.2rem;
    border-bottom: 1px solid #eee;
  }

  .chat-header-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .chat-messages {
    padding: 1rem;
    overflow-y: auto;
    background-color: #f3f6fb;
  }

  .chat-row {
    display: flex;
    margin-bottom: 0.6rem;
  }

  .chat-row.other {
    justify-content: flex-start;
  }

  .chat-row.me {
    justify-content: flex-end;
  }

  .chat-bubble-wrap {
    max-width: 70%;
    display: flex;
    gap: 0.4rem;
  }

  .chat-bubble {
    padding: 0.5rem 0.8rem;
    border-radius: 18px;
    font-size: 0.98rem;
    line-height: 1.4;
    background-color: #e3f1ff;
    color: #000;
    word-break: break-word;
    width: fit-content;
  }

  .chat-row.me .chat-bubble {
    background-color: #dbeafe;
    margin-left: auto;
  }

  .chat-bubble-img {
    padding: 0.3rem;
    border-radius: 18px;
    background-color: #e3f1ff;
    width: fit-content;
    overflow: hidden;
  }

  .chat-row.me .chat-bubble-img {
    background-color: #dbeafe;
    margin-left: auto;
  }

  /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ "‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ç‡∏ß‡∏≤" ‡∏ï‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
  .chat-meta{
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.15rem;
  }

  .chat-meta-name{
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .chat-meta-time{
    flex-shrink: 0;
    text-align: right;
    white-space: nowrap;
  }

  .chat-input-area {
    padding: 0.7rem 1rem;
    background-color: #ffffff;
  }

  .chat-input-box {
    background-color: #f3f4f6;
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chat-input-box input {
    border: none;
    background: transparent;
    box-shadow: none !important;
  }

  .chat-input-box input:focus {
    outline: none;
  }

  .send-btn-icon {
    font-size: 1.4rem;
  }

  .attach-btn-icon {
    font-size: 1.25rem;
  }

  .chat-attach-img {
    max-width: 220px;
    border-radius: 14px;
    display: block;
  }

  @media (max-width: 768px) {
    .chat-wrapper {
      border-radius: 0;
      height: calc(100vh - 56px);
      box-shadow: none;
      margin-top: 0;
      margin-bottom: 0;
    }
  }
</style>

<div class="container-fluid px-0">
  <div class="chat-wrapper">
    <!-- HEADER -->
    <div class="chat-header d-flex align-items-center">
      <button
        type="button"
        class="btn btn-link text-dark p-0 me-2"
        onclick="window.history.back()">
        <i class="fa-solid fa-arrow-left fa-lg"></i>
      </button>

      {% if is_group and post %}
        {% if post.image %}
          <img src="{{ post.image.url }}" class="chat-header-avatar me-2" alt="{{ post.title }}">
        {% else %}
          <img src="{% static 'images/default_profile.png' %}" class="chat-header-avatar me-2" alt="">
        {% endif %}
        <div>
          <div class="fw-semibold">
            {{ post.title }}
          </div>
          <div class="small text-muted">
            ‡πÅ‡∏ä‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
          </div>
        </div>
      {% else %}
        {% if other_user.profile.profile_picture %}
          <img src="{{ other_user.profile.profile_picture.url }}" class="chat-header-avatar me-2" alt="{{ other_user.get_full_name }}">
        {% else %}
          <img src="{% static 'images/default_profile.png' %}" class="chat-header-avatar me-2" alt="">
        {% endif %}
        <div>
          <div class="fw-semibold">
            {{ other_user.get_full_name|default:other_user.username }}
          </div>
          <div class="small text-muted">
            ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
          </div>
        </div>
      {% endif %}
    </div>

    <!-- MESSAGE LIST -->
    <div id="chatMessages" class="chat-messages flex-grow-1">
      {% for msg in chat_messages %}
        <div class="chat-row {% if msg.sender == request.user %}me{% else %}other{% endif %}">
          <div class="chat-bubble-wrap">
            {% if msg.sender != request.user %}
              {% if msg.sender.profile.profile_picture %}
                <img src="{{ msg.sender.profile.profile_picture.url }}"
                     class="chat-header-avatar"
                     style="width:32px;height:32px;border-radius:50%;object-fit:cover;"
                     alt="{{ msg.sender.get_full_name }}">
              {% else %}
                <img src="{% static 'images/default_profile.png' %}"
                     class="chat-header-avatar"
                     style="width:32px;height:32px;border-radius:50%;object-fit:cover;"
                     alt="">
              {% endif %}
            {% endif %}

            <div>
              {% if msg.content %}
              <div class="chat-bubble">
                {{ msg.content|linebreaksbr }}
              </div>
              {% endif %}

              {% if msg.attachment %}
                {% if msg.is_image %}
                  <div class="chat-bubble-img{% if msg.content %} mt-1{% endif %}">
                    <img src="{{ msg.attachment.url }}" class="chat-attach-img" alt="attachment">
                  </div>
                {% else %}
                  <div class="chat-bubble{% if msg.content %} mt-1{% endif %}">
                    <a href="{{ msg.attachment.url }}" target="_blank" rel="noopener">
                      ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö: {{ msg.attachment.name }}
                    </a>
                  </div>
                {% endif %}
              {% endif %}

              <!-- ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ç‡∏ß‡∏≤ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö localtime) -->
              <div class="chat-meta">
                <span class="chat-meta-name">
                  {{ msg.sender.get_full_name|default:msg.sender.username }}
                </span>
                <span class="chat-meta-time">
                  {{ msg.created_at|localtime|date:"d/m/Y H:i" }}
                </span>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted small text-center mt-3">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üôÇ
        </p>
      {% endfor %}
    </div>

    <!-- INPUT -->
    <div class="chat-input-area">
      <form id="chatForm" class="chat-input-box" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <input id="chatFileInput" type="file" name="file" hidden />

        <button type="button" class="btn btn-link p-0 attach-btn-icon"
                onclick="document.getElementById('chatFileInput').click()">
          <i class="fa-solid fa-paperclip"></i>
        </button>

        <input
          id="chatMessageInput"
          name="content"
          type="text"
          class="form-control"
          placeholder="Aa"
          autocomplete="off"
        />

        <button type="submit" class="btn btn-link p-0 send-btn-icon">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </form>

      <!-- Image preview before send -->
      <div id="filePreview" class="d-none px-3 py-2 border-top" style="background:#f9fafb;">
        <div class="d-flex align-items-center gap-2">
          <img id="filePreviewImg" src="" style="max-height:80px;border-radius:10px;object-fit:cover;" alt="preview">
          <span id="filePreviewName" class="text-muted small text-truncate" style="max-width:200px;"></span>
          <button type="button" class="btn btn-sm btn-outline-danger rounded-pill ms-auto" id="filePreviewClear">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const roomId = {{ room.id }};
  const currentUserId = "{{ request.user.id }}";
  const messagesEl = document.getElementById('chatMessages');
  const formEl = document.getElementById('chatForm');
  const inputEl = document.getElementById('chatMessageInput');
  const fileEl = document.getElementById('chatFileInput');

  const uploadUrl = "{% url 'chat:upload_message' room.id %}";

  messagesEl.scrollTop = messagesEl.scrollHeight;

  let chatSocket = null;
  try {
    const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socketUrl = `${scheme}://${window.location.host}/ws/chat/${roomId}/`;
    chatSocket = new WebSocket(socketUrl);

    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      appendMessage(data);
    };

    chatSocket.onclose = function(e) {
      console.warn('Chat socket closed', e);
    };
  } catch (err) {
    console.warn('Cannot open WebSocket:', err);
  }

  function escapeHtml(text) {
    return String(text || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  // ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ ‚Äú‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‚Äù (Asia/Bangkok)
  function formatDateTimeBangkok(input) {
    if (!input) return "";

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á timestamp, ISO, ‡∏´‡∏£‡∏∑‡∏≠ string ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
    const d = new Date(input);
    if (isNaN(d)) {
      // ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡πá‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ (‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á)
      return String(input);
    }

    const parts = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
    }).formatToParts(d);

    const get = (type) => parts.find(p => p.type === type)?.value || "";
    return `${get('day')}/${get('month')}/${get('year')} ${get('hour')}:${get('minute')}`;
  }

  function appendMessage(data) {
    const isMe = data.sender_id === currentUserId;

    const row = document.createElement('div');
    row.className = 'chat-row ' + (isMe ? 'me' : 'other');

    const wrapper = document.createElement('div');
    wrapper.className = 'chat-bubble-wrap';

    const bubbleContainer = document.createElement('div');

    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    if (data.message && String(data.message).trim() !== "") {
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble';
      bubble.innerHTML = escapeHtml(data.message);
      bubbleContainer.appendChild(bubble);
    }

    // ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (‡πÅ‡∏¢‡∏Å bubble ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
    if (data.file_url) {
      if (data.is_image) {
        const attach = document.createElement('div');
        attach.className = 'chat-bubble-img';
        if (data.message && String(data.message).trim() !== "") attach.classList.add('mt-1');
        attach.innerHTML = `<img src="${data.file_url}" class="chat-attach-img" alt="attachment">`;
        bubbleContainer.appendChild(attach);
      } else {
        const attach = document.createElement('div');
        attach.className = 'chat-bubble';
        if (data.message && String(data.message).trim() !== "") attach.classList.add('mt-1');
        attach.innerHTML = `<a href="${data.file_url}" target="_blank" rel="noopener">
          ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö: ${escapeHtml(data.file_name || "download")}
        </a>`;
        bubbleContainer.appendChild(attach);
      }
    }

    // ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ç‡∏ß‡∏≤
    const meta = document.createElement('div');
    meta.className = 'chat-meta';

    const metaName = document.createElement('span');
    metaName.className = 'chat-meta-name';
    metaName.textContent = data.sender_name || "";

    const metaTime = document.createElement('span');
    metaTime.className = 'chat-meta-time';

    // ‚úÖ ‡∏ñ‡πâ‡∏≤ backend ‡∏™‡πà‡∏á created_at_iso ‡∏°‡∏≤‡∏à‡∏∞‡∏ï‡∏£‡∏á‡∏™‡∏∏‡∏î
    const rawTime = data.created_at_iso || data.created_at;
    metaTime.textContent = formatDateTimeBangkok(rawTime);

    meta.appendChild(metaName);
    meta.appendChild(metaTime);

    bubbleContainer.appendChild(meta);

    wrapper.appendChild(bubbleContainer);
    row.appendChild(wrapper);
    messagesEl.appendChild(row);

    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Image preview logic
  const previewDiv = document.getElementById('filePreview');
  const previewImg = document.getElementById('filePreviewImg');
  const previewName = document.getElementById('filePreviewName');
  const previewClear = document.getElementById('filePreviewClear');

  fileEl.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) { previewDiv.classList.add('d-none'); return; }
    previewName.textContent = file.name;
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => { previewImg.src = e.target.result; previewImg.classList.remove('d-none'); };
      reader.readAsDataURL(file);
    } else {
      previewImg.classList.add('d-none');
    }
    previewDiv.classList.remove('d-none');
  });

  previewClear.addEventListener('click', () => {
    fileEl.value = '';
    previewDiv.classList.add('d-none');
    previewImg.src = '';
    previewName.textContent = '';
  });

  formEl.addEventListener('submit', async function(e) {
    const text = inputEl.value.trim();
    const file = fileEl.files[0];

    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå -> upload ‡∏ú‡πà‡∏≤‡∏ô HTTP
    if (file) {
      e.preventDefault();

      const fd = new FormData();
      fd.append('content', text);
      fd.append('file', file);

      const res = await fetch(uploadUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
        body: fd
      });

      if (res.ok) {
        inputEl.value = '';
        fileEl.value = '';
        previewDiv.classList.add('d-none');
        previewImg.src = '';
        previewName.textContent = '';
      }
      return;
    }

    // ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå -> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô websocket (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    if (!text) {
      e.preventDefault();
      return;
    }

    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
      e.preventDefault();
      chatSocket.send(JSON.stringify({ message: text }));
      inputEl.value = '';
    }
  });
});
</script>
{% endblock %}
