{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-3">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- หัวข้อใหญ่ 2 ตัว : จัดการบัญชี / ยืนยันโพสต์ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="admin-main-tabs d-flex">
      <a href="{% url 'approver_dashboard' %}?main=manage"
         class="admin-main-tab {% if main_tab|default:'manage' == 'manage' %}active{% endif %}">
        จัดการ
      </a>
      <a href="{% url 'approver_dashboard' %}?main=approve"
         class="admin-main-tab {% if main_tab == 'approve' %}active{% endif %}">
        ยืนยันโพสต์
      </a>
    </div>
  </div>

  {# ============================ PART 1 : จัดการบัญชี ============================ #}
  {% if main_tab|default:'manage' == 'manage' %}

    <!-- แท็บย่อย 3 ตัว : บัญชี / โพสต์ / รายงาน -->
    <div class="admin-sub-tabs mb-3">
      <a href="{% url 'approver_dashboard' %}?main=manage&sub=accounts"
         class="admin-sub-tab {% if sub_tab|default:'accounts' == 'accounts' %}active{% endif %}">
        บัญชี
      </a>
      <a href="{% url 'approver_dashboard' %}?main=manage&sub=posts"
         class="admin-sub-tab {% if sub_tab == 'posts' %}active{% endif %}">
        โพสต์
      </a>
      <a href="{% url 'approver_dashboard' %}?main=manage&sub=reports"
         class="admin-sub-tab {% if sub_tab == 'reports' %}active{% endif %}">
        รายงาน
      </a>
    </div>

    {# ---------- 1.1 แท็บ "บัญชี" ---------- #}
    {% if sub_tab|default:'accounts' == 'accounts' %}
      <div class="admin-card">
        {% for u in accounts %}
          <div class="admin-row">
            <div class="flex-grow-1">
              <a href="{% url 'profile_detail' u.id %}" class="admin-link">
                {{ u.get_full_name|default:u.username }}
              </a>
              <div class="text-muted small">{{ u.email }}</div>
            </div>
            <div class="d-flex gap-2">
              <!-- ✅ ปุ่มลบบัญชี = ปิดการใช้งาน (ไม่ลบข้อมูลจริง) -->
              <form action="{% url 'deactivate_user' u.id %}" method="post" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn-admin-danger">ลบ</button>
              </form>
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-4">
            ยังไม่มีบัญชีผู้ใช้ในระบบ
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {# ---------- 1.2 แท็บ "โพสต์" ---------- #}
    {% if sub_tab == 'posts' %}
      <div class="admin-card">
        {% for p in all_posts %}
          <div class="admin-row">
            <div class="flex-grow-1">
              <a href="{% url 'post:post_detail' p.id %}" class="admin-link" target="_blank">
                {{ p.title }}
              </a>
              <div class="small text-muted">
                ผู้สร้าง:
                {{ p.organizer.get_full_name|default:p.organizer.username }}

                {# ✅ แสดงสถานะถ้าโพสต์ถูกซ่อนหรือลบแล้ว #}
                {% if p.is_deleted %}
                  <span class="admin-status-badge admin-status-deleted">ลบแล้ว</span>
                {% elif p.is_hidden %}
                  <span class="admin-status-badge admin-status-hidden">ซ่อนแล้ว</span>
                {% endif %}
              </div>
            </div>
            <div class="d-flex gap-2">
              {% if p.is_deleted or p.is_hidden %}
                {# ✅ ถ้าโพสต์ถูกซ่อน/ลบแล้ว ให้แสดงปุ่มกู้คืนแทน #}
                <form action="{% url 'restore_post' p.id %}" method="post" style="margin: 0;">
                  {% csrf_token %}
                  <button type="submit" class="btn-admin-secondary">กู้คืน</button>
                </form>
              {% else %}
                {# ✅ ปกติ: ยังไม่ถูกซ่อน/ลบ -> แสดงปุ่มซ่อน/ลบ #}
                <form action="{% url 'hide_post' p.id %}" method="post" style="margin: 0;">
                  {% csrf_token %}
                  <button type="submit" class="btn-admin-secondary">ซ่อน</button>
                </form>
                <form action="{% url 'soft_delete_post' p.id %}" method="post" style="margin: 0;">
                  {% csrf_token %}
                  <button type="submit" class="btn-admin-danger">ลบ</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-4">
            ยังไม่มีโพสต์ในระบบ
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {# ---------- 1.3 แท็บ "รายงาน" ---------- #}
    {% if sub_tab == 'reports' %}
      <div class="admin-card mb-4">
        <div class="admin-section-title mb-2">รายงานโพสต์</div>
        {% for r in post_reports %}
          <div class="admin-row">
            <div class="flex-grow-1">
              <a class="admin-link" href="{% url 'post:post_detail' r.post.id %}" target="_blank">
                {{ r.post.title }}
              </a>
              <div class="small text-muted">
                เหตุผล: {{ r.reason }} |
                ผู้รายงาน: {{ r.reporter.get_full_name|default:r.reporter.username }}
                {% if r.evidence_image %}
                  | <a href="{{ r.evidence_image.url }}" target="_blank">ดูรูปหลักฐาน</a>
                {% endif %}
              </div>
            </div>
            <div class="d-flex gap-2">
              <form action="{% url 'handle_post_report_hide' r.id %}" method="post" style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn-admin-secondary">ซ่อน</button>
              </form>
              <form action="{% url 'handle_post_report_delete' r.id %}" method="post" style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn-admin-danger">ลบ</button>
              </form>
            </div>
          </div>
        {% empty %}
          <div class="text-muted small">ยังไม่มีรายงานโพสต์</div>
        {% endfor %}
      </div>

      <div class="admin-card">
        <div class="admin-section-title mb-2">รายงานบัญชี</div>
        {% for r in user_reports %}
          <div class="admin-row">
            <div class="flex-grow-1">
              <a class="admin-link" href="{% url 'profile_detail' r.user.id %}" target="_blank">
                {{ r.user.get_full_name|default:r.user.username }}
              </a>
              <div class="small text-muted">
                เหตุผล: {{ r.reason }} |
                ผู้รายงาน: {{ r.reporter.get_full_name|default:r.reporter.username }}
                {% if r.evidence_image %}
                  | <a href="{{ r.evidence_image.url }}" target="_blank">ดูรูปหลักฐาน</a>
                {% endif %}
              </div>
            </div>
            <div class="d-flex gap-2">
              <form action="{% url 'handle_user_report_reject' r.id %}" method="post" style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn-admin-secondary">ไม่ลบ</button>
              </form>
              <form action="{% url 'handle_user_report_deactivate' r.id %}" method="post" style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn-admin-danger">ลบบัญชี</button>
              </form>
            </div>
          </div>
        {% empty %}
          <div class="text-muted small">ยังไม่มีรายงานบัญชี</div>
        {% endfor %}
      </div>
    {% endif %}

  {% else %}
  {# ============================ PART 2 : ยืนยันโพสต์ ============================ #}

    <div class="admin-card">
      <div class="admin-section-title mb-3">
        ยืนยันการโพสต์
      </div>

      {% for p in pending_posts %}
        <div class="admin-row">
          <div class="flex-grow-1">
            <!-- ให้กดดูโพสต์ได้ -->
            <a href="{% url 'post:post_detail' p.id %}" class="admin-link" target="_blank">
              {{ p.title }}
            </a>
            <div class="small text-muted">
              ผู้ส่งคำขอ:
              {{ p.organizer.get_full_name|default:p.organizer.username }}
            </div>
          </div>
          <div class="d-flex gap-2">
            <form action="{% url 'reject_post' p.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn-admin-danger-soft">ปฏิเสธ</button>
            </form>
            <form action="{% url 'approve_post' p.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn-admin-success">ยอมรับ</button>
            </form>
          </div>
        </div>
      {% empty %}
        <div class="text-center text-muted py-4">
          ไม่มีโพสต์ที่รอการยืนยัน
        </div>
      {% endfor %}
    </div>

  {% endif %}

</div>

<style>
  body {
    background-color: #f5f6f8 !important;
    font-family: 'Kanit', sans-serif;
  }

  .admin-main-tabs {
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid #d0d0d0;
  }

  .admin-main-tab {
    padding: 0.55rem 1.8rem;
    font-weight: 600;
    text-decoration: none;
    color: #333;
    background-color: #ffffff;
    border-right: 1px solid #d0d0d0;
  }
  .admin-main-tab:last-child {
    border-right: none;
  }
  .admin-main-tab.active {
    background-color: #6f8bff;
    color: #fff;
  }

  .admin-sub-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 1.5rem;
  }

  .admin-sub-tab {
    flex: 0 0 220px;
    text-align: center;
    padding: 0.6rem 1rem;
    border: 1px solid #cfcfcf;
    text-decoration: none;
    color: #333;
    background-color: #fff;
  }
  .admin-sub-tab:first-child {
    border-radius: 999px 0 0 999px;
  }
  .admin-sub-tab:last-child {
    border-radius: 0 999px 999px 0;
  }
  .admin-sub-tab:nth-child(2) {
    border-left: none;
    border-right: none;
  }
  .admin-sub-tab.active {
    background-color: #6f8bff;
    color: #fff;
  }

  .admin-card {
    background-color: #fff;
    border-radius: 16px;
    padding: 1.25rem 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }

  .admin-section-title {
    font-weight: 600;
    font-size: 1.05rem;
  }

  .admin-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.65rem 0.75rem;
    border-bottom: 1px solid #e5e5e5;
  }
  .admin-row:last-child {
    border-bottom: none;
  }

  .admin-link {
    text-decoration: none;
    color: #222;
    font-weight: 500;
  }
  .admin-link:hover {
    text-decoration: underline;
  }

  .btn-admin-secondary,
  .btn-admin-danger,
  .btn-admin-danger-soft,
  .btn-admin-success {
    border-radius: 999px;
    padding: 0.25rem 1.1rem;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .btn-admin-secondary {
    background-color: #e4e4e4;
    color: #333;
  }
  .btn-admin-secondary:hover {
    background-color: #d5d5d5;
  }

  .btn-admin-danger {
    background-color: #ff6b6b;
    color: #fff;
  }
  .btn-admin-danger:hover {
    background-color: #e55353;
  }

  .btn-admin-danger-soft {
    background-color: #ffe2e2;
    color: #c04747;
  }

  .btn-admin-success {
    background-color: #8ddc98;
    color: #1f6b32;
  }

  /* ✅ Badge แสดงสถานะซ่อน/ลบในหน้า approver */
  .admin-status-badge {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.05rem 0.4rem;
    border-radius: 999px;
    font-size: 0.7rem;
  }
  .admin-status-hidden {
    background-color: #ffe9b3;
    color: #8a6d1d;
  }
  .admin-status-deleted {
    background-color: #ffd0d0;
    color: #8b1f1f;
  }

  @media (max-width: 768px) {
    .admin-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }
</style>
{% endblock %}
