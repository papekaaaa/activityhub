{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card border-0 shadow-sm p-4" style="border-radius: 20px;">

                <!-- ฟอร์มครอบทั้งรูป + ข้อมูล -->
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row align-items-center">
                        
                        <!-- Profile Picture Section -->
                        <div class="col-md-5 text-center mb-4 mb-md-0">
                            <div class="position-relative d-inline-block">
                                {% if user.profile.profile_picture %}
                                    <img id="profilePreview" 
                                         src="{{ user.profile.profile_picture.url }}" 
                                         class="rounded-circle shadow-sm" 
                                         alt="Profile Picture"
                                         style="width: 250px; height: 250px; object-fit: cover;">
                                {% else %}
                                    <img id="profilePreview" 
                                         src="{% static 'images/default_profile.png' %}" 
                                         class="rounded-circle shadow-sm" 
                                         alt="Default Picture"
                                         style="width: 250px; height: 250px; object-fit: cover;">
                                {% endif %}
                            </div>

                            <!-- ปุ่มแก้ไขโปรไฟล์ (กดแล้วเปิด input ของฟอร์ม) -->
                            <div class="mt-3">
                                <label for="id_profile_picture" 
                                       class="btn btn-light shadow-sm"
                                       style="border: 1px solid #ccc; border-radius: 8px; padding: 6px 18px; font-size: 15px; font-weight: 500;">
                                    แก้ไขโปรไฟล์
                                </label>
                                {{ profile_form.profile_picture }}
                            </div>
                        </div>

                        <!-- Profile Form Section -->
                        <div class="col-md-7">
                            <div class="row g-3">

                                <!-- ชื่อจริง -->
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">ชื่อ</label>
                                    {{ user_form.first_name }}
                                </div>
                                <!-- นามสกุล -->
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">นามสกุล</label>
                                    {{ user_form.last_name }}
                                </div>

                                <!-- ชื่อเล่น / วันเกิด -->
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">ชื่อเล่น</label>
                                    {{ profile_form.nickname }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">วันเดือนปีเกิด</label>
                                    <input type="text" id="birth_date" name="birth_date" class="form-control input-date" placeholder="เลือกวันเกิด" value="{{ profile_form.birth_date.value|default_if_none:'' }}" autocomplete="off" />
                                </div>

                                <!-- เพศ / เบอร์โทร -->
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">เพศ</label>
                                    {{ profile_form.gender }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">เบอร์โทร</label>
                                    {{ profile_form.phone }}
                                </div>

                                <!-- ที่อยู่ -->
                                <div class="col-12">
                                    <label class="form-label fw-semibold">ที่อยู่</label>
                                    {{ profile_form.address }}
                                </div>

                                <!-- ช่องทางติดต่อ -->
                                <div class="col-12">
                                    <label class="form-label fw-semibold">ช่องทางติดต่ออื่น (Line ID, Facebook)</label>
                                    {{ profile_form.contact_info }}
                                </div>

                                <!-- อีเมล -->
                                <!-- อีเมล (แสดงเฉยๆ ห้ามแก้ไข) -->
                                <div class="col-12">
                                    <label class="form-label fw-semibold">อีเมล</label>
                                    <input type="email" name="email" value="{{ user.email }}" class="form-control" readonly disabled
                                        style="border: 1.5px solid #ccc; border-radius: 10px; padding: 8px 10px; font-size: 15px; background:#f5f5f5; color:#888;">
                                </div>
                            </div>

                            <!-- ปุ่มบันทึก -->
                            <div class="text-center mt-4">
                                <button class="btn px-5 py-2" 
                                        style="background-color:#B9E6C9; border:none; border-radius:20px; font-weight:600; color:#000;">
                                    เสร็จสิ้น
                                </button>

                                <!-- ✅ เพิ่มปุ่มเปลี่ยนรหัสผ่าน (มีไอคอน) -->
                                <a href="{% url 'password_change_confirm' %}"
                                   class="btn btn-outline-dark px-4 py-2 ms-2"
                                   style="border-radius:20px;">
                                   <i class="fa-solid fa-key me-2"></i> เปลี่ยนรหัสผ่าน
                                </a>

                                <a href="{% url 'profile' %}" 
                                   class="btn btn-outline-secondary px-4 py-2 ms-2" 
                                   style="border-radius:20px;">
                                   ยกเลิก
                                </a>
                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- JS: Preview รูปโปรไฟล์ -->
<script>
    const fileInput = document.getElementById('id_profile_picture');
    const preview = document.getElementById('profilePreview');

    if (fileInput) {
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }
</script>

<style>
    /* ซ่อน input ของ Django (แต่ยังอยู่ในฟอร์ม) */
    #id_profile_picture {
        display: none;
    }

    /* ช่อง input ทั้งหมด */
    input[type="text"], input[type="email"], input[type="date"], input[type="number"], textarea, select {
        width: 100%;
        border: 1.5px solid #ccc;
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 15px;
        transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 5px rgba(0,123,255,0.2);
    }

    .btn-light:hover {
        background-color: #f1f1f1;
        border-color: #bbb;
    }
    /* Flatpickr date input style */
    .input-date { cursor: pointer; }
</style>

<!-- Flatpickr (Date Picker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const birthDateInput = document.getElementById("birth_date");
        if (birthDateInput) {
            flatpickr(birthDateInput, {
                enableTime: false,
                locale: "th",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d/m/Y",
                allowInput: true,
                maxDate: "today"
            });
        }
    });
</script>
{% endblock %}
