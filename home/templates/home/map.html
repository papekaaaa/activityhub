{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="fw-semibold mb-1">แผนที่กิจกรรม</h5>
      <p class="text-muted mb-3">
        แสดงตำแหน่งของกิจกรรมทั้งหมดจากโพสต์ในระบบ
        {% if not enable_geolocation %}(โหมดดูอย่างเดียว){% endif %}
      </p>

      <div id="activity-map" style="width: 100%; height: 540px; border-radius: 16px; overflow: hidden;"></div>
    </div>
  </div>
</div>

<!-- Leaflet CSS/JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<style>
  #activity-map {
    background: #f5f5f5;
  }

  /* label ที่ลอยอยู่เหนือหมุด */
  .leaflet-tooltip.event-label {
    background: #ffffff;
    border-radius: 999px;
    padding: 4px 10px;
    border: 1px solid rgba(0,0,0,0.15);
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    font-size: 12px;
    font-weight: 500;
    color: #333;
    white-space: nowrap;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const events = JSON.parse('{{ events_json|escapejs }}');  // จาก view
  const enableGeolocation = {{ enable_geolocation|yesno:"true,false" }};

  // ตั้งค่าแผนที่เริ่มต้น (โฟกัสไทยกลาง ๆ)
  const map = L.map("activity-map").setView([15.5, 101.0], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const eventMarkers = [];

  // วาดหมุดกิจกรรมจาก events_json
  events.forEach(ev => {
    if (ev.lat === null || ev.lng === null) return;

    const lat = ev.lat;
    const lng = ev.lng;

    const marker = L.marker([lat, lng]).addTo(map);

    // popup ปกติเมื่อคลิก
    marker.bindPopup(`
      <strong>${ev.title}</strong><br>
      ${ev.location ? ev.location : ""}<br>
      ${ev.date ? ev.date : ""}
    `);

    // ✅ label ถาวรเหนือหัวหมุด: ชื่อกิจกรรม + สถานที่
    const labelText = ev.location
      ? `${ev.title} - ${ev.location}`
      : ev.title;

    marker.bindTooltip(labelText, {
      permanent: true,
      direction: "top",
      offset: [0, -10],
      className: "event-label",
    });

    eventMarkers.push(marker);
  });

  // ถ้ามีหมุด ให้ zoom ให้พอดีทั้งหมด
  if (eventMarkers.length > 0) {
    const group = L.featureGroup(eventMarkers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  // --------------------------
  // ตำแหน่งผู้ใช้ (ใช้เฉพาะโหมดที่เปิด geolocation)
  // --------------------------
  {% comment %}
    view ที่เรียก template นี้:
      - ถ้าเป็นหน้า public ก่อน login -> enable_geolocation = False
      - ถ้าเป็นหน้า map ของ user ในระบบ -> enable_geolocation = True
  {% endcomment %}

  if (enableGeolocation && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const meIcon = L.icon({
        iconUrl: '{% static "images/pin-me.png" %}',
        iconSize: [34, 34],
        iconAnchor: [17, 34],
        popupAnchor: [0, -30],
      });

      const meMarker = L.marker([lat, lng], { icon: meIcon }).addTo(map);
      meMarker.bindPopup("ตำแหน่งของฉัน");

      // รวมหมุดทุกอันแล้ว zoom ให้เห็นทั้งหมด
      const all = [...eventMarkers, meMarker];
      if (all.length > 0) {
        const group = L.featureGroup(all);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    });
  }
});
</script>
{% endblock %}
