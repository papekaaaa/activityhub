{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid py-4">
  <div class="card shadow-sm border-0" style="border-radius: 18px;">
    <div class="card-body">
      <h5 class="fw-bold mb-1">กิจกรรมใกล้ตัวคุณ</h5>
      <p class="text-muted mb-3">
        แสดงเฉพาะกิจกรรมในรัศมี <strong>30 กิโลเมตร</strong> จากตำแหน่งปัจจุบันของคุณ
      </p>

      <!-- แถวค้นหาตำแหน่ง + ใช้ตำแหน่งปัจจุบัน -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2 nearby-top-row">
        <div class="d-flex flex-grow-1 gap-2 nearby-search-wrap">
          <input
            id="searchLocationInput"
            type="text"
            class="form-control"
            placeholder="ค้นหาตำแหน่ง เช่น มหาวิทยาลัยอุบลราชธานี"
          />
          <button id="searchLocationBtn" class="btn btn-primary px-4 fw-semibold">
            ค้นหาตำแหน่ง
          </button>
        </div>

        <button
          id="useCurrentLocationBtn"
          type="button"
          class="btn btn-link text-primary fw-semibold nearby-current-btn"
        >
          ใช้ตำแหน่งปัจจุบัน
        </button>
      </div>

      <small id="locationStatus" class="text-muted d-block mb-2">
        ใช้ตำแหน่งปัจจุบันหรือลองค้นหาตำแหน่งของคุณ
      </small>

      <!-- แผนที่ -->
      <div id="nearbyMap" style="width: 100%; height: 520px; border-radius: 16px; overflow: hidden;"></div>

      <p class="mt-3 mb-0">
        พบกิจกรรมใกล้สุดจำนวน
        <strong><span id="nearbyCount">0</span> กิจกรรม</strong> ในรัศมี 30 กิโลเมตร
      </p>
    </div>
  </div>
</div>

<style>
  #nearbyMap {
    margin-top: 8px;
  }

  /* ให้แถวบนสมส่วน ไม่เอนขวาเกินไป */
  .nearby-top-row {
    gap: 0.75rem;
  }

  .nearby-search-wrap {
    min-width: 260px;
  }

  .nearby-current-btn {
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .nearby-top-row {
      flex-direction: column;
      align-items: stretch;
    }
    .nearby-current-btn {
      align-self: flex-end;
      padding-right: 0;
    }
  }
</style>

<!-- Leaflet CDN (ถ้ายังไม่ได้ใส่ใน base.html) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --------------------- DATA จาก Django ---------------------
    // ใช้ escapejs ป้องกัน JSON พัง แล้วค่อย parse ที่ฝั่ง JS
    const EVENTS = JSON.parse('{{ events_json|escapejs }}');

    const RADIUS_KM = 30;

    // --------------------- สร้าง MAP ---------------------------
    const map = L.map("nearbyMap").setView([15.0, 100.0], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    // Layer สำหรับหมุดกิจกรรม + เส้น
    const eventLayer = L.layerGroup().addTo(map);
    const lineLayer = L.layerGroup().addTo(map);

    // ใช้ marker มาตรฐานของ Leaflet ให้ชัวร์ว่า "ไอคอนขึ้น"
    const myIcon = L.icon({
      iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      shadowSize: [41, 41],
    });

    const myLocationIcon = L.icon({
      iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",
      iconSize: [30, 50],
      iconAnchor: [15, 50],
      popupAnchor: [0, -46],
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      shadowSize: [41, 41],
    });

    let myMarker = null;

    // --------------------- Haversine ---------------------------
    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = ((lat2 - lat1) * Math.PI) / 180;
      const dLon = ((lon2 - lon1) * Math.PI) / 180;
      const la1 = (lat1 * Math.PI) / 180;
      const la2 = (lat2 * Math.PI) / 180;

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(la1) * Math.cos(la2) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // --------------------- วาดหมุดกิจกรรม + คำนวนระยะ ----------------
    function updateNearby(lat, lng) {
      eventLayer.clearLayers();
      lineLayer.clearLayers();

      let count = 0;
      const bounds = [];

      EVENTS.forEach(ev => {
        const d = haversineKm(lat, lng, ev.lat, ev.lng);

        if (d <= RADIUS_KM) {
          count += 1;
          const marker = L.marker([ev.lat, ev.lng], { icon: myIcon }).addTo(eventLayer);

          marker.bindPopup(`
            <strong>${ev.title}</strong><br/>
            ${ev.location || ""}<br/>
            ระยะทางประมาณ ${d.toFixed(1)} กม.
          `);

          // เส้นระหว่างเรา ↔ กิจกรรม
          const line = L.polyline([[lat, lng], [ev.lat, ev.lng]], {
            color: "#444",
            weight: 1,
            dashArray: "4 6",
          }).addTo(lineLayer);

          bounds.push([ev.lat, ev.lng]);
        }
      });

      document.getElementById("nearbyCount").textContent = count;

      // รวม bounds ทั้งเรา + กิจกรรมใกล้ตัว
      if (bounds.length) {
        bounds.push([lat, lng]);
        map.fitBounds(bounds, { padding: [40, 40] });
      } else {
        // ถ้าไม่มีกิจกรรมในรัศมี 30 กม. ก็แค่ zoom เข้าหาตำแหน่งเรา
        map.setView([lat, lng], 13);
      }
    }

    // วาง marker สำหรับตำแหน่งเรา
    function setMyLocation(lat, lng, label) {
      if (myMarker) {
        myMarker.setLatLng([lat, lng]);
      } else {
        myMarker = L.marker([lat, lng], { icon: myLocationIcon }).addTo(map);
      }
      myMarker.bindPopup(label || "ตำแหน่งของคุณ").openPopup();
      updateNearby(lat, lng);
    }

    // --------------------- Geolocation ปัจจุบัน ----------------
    const statusEl = document.getElementById("locationStatus");
    const currentBtn = document.getElementById("useCurrentLocationBtn");

    function useCurrentLocation() {
      if (!navigator.geolocation) {
        statusEl.textContent = "เบราว์เซอร์ไม่รองรับการใช้ตำแหน่งปัจจุบัน";
        return;
      }

      statusEl.textContent = "กำลังดึงตำแหน่งปัจจุบันของคุณ...";

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          statusEl.textContent = "ใช้ตำแหน่งปัจจุบันเรียบร้อย";
          setMyLocation(lat, lng, "ตำแหน่งของคุณ");
        },
        err => {
          statusEl.textContent = "ไม่สามารถดึงตำแหน่งปัจจุบันได้: " + err.message;
        }
      );
    }

    currentBtn.addEventListener("click", e => {
      e.preventDefault();
      useCurrentLocation();
    });

    // ลองใช้ตำแหน่งปัจจุบันอัตโนมัติครั้งหนึ่งตอนโหลดหน้า
    useCurrentLocation();

    // --------------------- ค้นหาตำแหน่งด้วยข้อความ ----------------
    const searchInput = document.getElementById("searchLocationInput");
    const searchBtn = document.getElementById("searchLocationBtn");

    async function searchLocation() {
      const q = searchInput.value.trim();
      if (!q) return;

      statusEl.textContent = "กำลังค้นหาตำแหน่งจากคำค้นหา...";

      try {
        const url =
          "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" +
          encodeURIComponent(q);

        const res = await fetch(url, {
          headers: {
            "Accept-Language": "th,en;q=0.8",
          },
        });
        const data = await res.json();

        if (!data.length) {
          statusEl.textContent = "ไม่พบตำแหน่งจากคำค้นหานี้";
          return;
        }

        const lat = parseFloat(data[0].lat);
        const lng = parseFloat(data[0].lon);
        statusEl.textContent =
          "กำหนดตำแหน่งจากคำค้นหา: " + (data[0].display_name || q);
        setMyLocation(lat, lng, "ตำแหน่งจากการค้นหา");
      } catch (e) {
        console.error(e);
        statusEl.textContent = "เกิดข้อผิดพลาดในการค้นหาตำแหน่ง";
      }
    }

    searchBtn.addEventListener("click", e => {
      e.preventDefault();
      searchLocation();
    });

    searchInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchLocation();
      }
    });
  });
</script>

{% endblock %}
