{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  /* ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏•‡∏°‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô */
  .avatar-circle-40 {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    display: block;
  }

  /* ‡∏õ‡∏£‡∏±‡∏ö modal ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ß‡∏¢ */
  #registrantModal .modal-dialog {
    max-width: 1100px;
  }

  #registrantModal .table-responsive {
    max-height: 60vh; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô‡∏à‡∏≠ */
  }

  #registrantModal thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 1;
  }

  #registrantModal .table th,
  #registrantModal .table td {
    white-space: nowrap;
    font-size: 0.9rem;
  }
</style>

<div class="container-fluid px-4 mt-3">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
      <a href="{% url 'home:home' %}" class="text-decoration-none text-dark d-inline-flex align-items-center mb-3">
        <i class="fa-solid fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </a>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° -->
      <div class="bg-white shadow-sm rounded-4 overflow-hidden position-relative">

        {% if post.image %}
        <!-- ‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á -->
        <div class="w-100" style="max-height: 340px; overflow: hidden;">
          <img
            src="{{ post.image.url }}"
            alt="{{ post.title }}"
            class="w-100"
            style="object-fit: cover;"
          />
        </div>
        {% endif %}

        <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ -->
        <div class="p-4">

          <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° + ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="pe-3">
              <h3 class="fw-bold mb-2">{{ post.title }}</h3>
              <p class="mb-1 text-muted">
                üìÖ {{ post.event_date|date:"j F Y" }}
              </p>
              <p class="mb-1 text-muted">
                üìç {{ post.location }}
              </p>
            </div>

            <!-- ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö -->
            <div class="text-end">
              <div class="d-flex align-items-center justify-content-end mb-1">
                {% if post.organizer.profile.profile_picture %}
                  <img
                    src="{{ post.organizer.profile.profile_picture.url }}"
                    class="avatar-circle-40 me-2"
                    alt="{{ post.organizer.get_full_name }}"
                  />
                {% else %}
                  <img
                    src="{% static 'images/default_profile.png' %}"
                    class="avatar-circle-40 me-2"
                    alt="Default profile"
                  />
                {% endif %}
                <div class="text-start">
                  <div class="fw-semibold">{{ post.organizer.first_name }} {{ post.organizer.last_name }}</div>
                  <small class="text-muted">{{ post.created_at|date:"d M Y" }}</small>
                </div>
              </div>

              {# ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å registrations / slots_available #}
              {% with registered_count=post.registrations.count %}
              <div class="small text-muted">
                ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö {{ registered_count }}/{{ post.slots_available }}
                {% if registered_count > 0 %}
                  <button
                    type="button"
                    class="btn btn-link btn-sm p-0 ms-2 align-baseline"
                    data-bs-toggle="modal"
                    data-bs-target="#registrantModal"
                  >
                    ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ({{ registered_count }})
                  </button>
                {% endif %}
              </div>
              {% endwith %}
            </div>
          </div>

          <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° -->
          <div class="mb-3">
            <p class="mb-0">
              {{ post.description|linebreaksbr }}
            </p>
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ + ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà) -->
          <div class="d-flex justify-content-between align-items-center mb-3 small text-muted">
            <span>
              {% if post.fee %}
                ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: {{ post.fee }} ‡∏ö‡∏≤‡∏ó
              {% else %}
                ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
              {% endif %}
            </span>
            <span>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {{ post.category }}</span>
          </div>

          <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ + ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô + ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
          <div class="d-flex justify-content-between align-items-center mt-2">

            <!-- ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ -->
            <button
              type="button"
              class="btn btn-link text-dark p-0 d-inline-flex align-items-center"
              id="openScheduleBtn"
            >
              <i class="fa-solid fa-arrow-left me-2"></i> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
            </button>

            <!-- ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
            <div class="d-flex align-items-center gap-3">

              {% if user.is_authenticated %}
              <!-- LIKE -->
              <button
                type="button"
                class="btn btn-link p-0 like-btn"
                data-id="{{ post.id }}"
                aria-label="like"
              >
                {% if user in post.likes.all %}
                  <i id="like-icon-{{ post.id }}" class="fas fa-heart fs-5 text-danger"></i>
                {% else %}
                  <i id="like-icon-{{ post.id }}" class="far fa-heart fs-5"></i>
                {% endif %}
              </button>

              <!-- COMMENT (‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) -->
              <a
                href="#comments"
                class="text-dark"
                aria-label="comments"
              >
                <i class="fa-regular fa-comment fs-5"></i>
              </a>

              <!-- SAVE -->
              <button
                type="button"
                class="btn btn-link p-0 save-btn"
                data-id="{{ post.id }}"
                aria-label="save"
              >
                {% if user in post.saves.all %}
                  <i id="save-icon-{{ post.id }}" class="fas fa-bookmark fs-5 text-primary"></i>
                {% else %}
                  <i id="save-icon-{{ post.id }}" class="far fa-bookmark fs-5"></i>
                {% endif %}
              </button>
              {% endif %}

              <!-- ‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ register_activity ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤ allow_register = True -->
              {% if post.allow_register %}
              <a
                href="{% url 'activity_register:register_activity' post.id %}"
                class="btn btn-success rounded-pill px-4 fw-semibold"
              >
                ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
              </a>
              {% endif %}
            </div>
          </div>

          <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
          <div id="comments" class="mt-4 border-top pt-3">
            <h6 class="fw-bold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h6>

            {% if review_count > 0 %}
              <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ -->
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  {% for i in "12345" %}
                    {% if forloop.counter <= avg_rating_int %}
                      <i class="fa-solid fa-star text-warning"></i>
                    {% else %}
                      <i class="fa-regular fa-star text-warning"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <div class="small text-muted">
                  ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ {{ avg_rating|floatformat:1 }} ‡∏à‡∏≤‡∏Å {{ review_count }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                </div>
              </div>

              <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
              {% for review in reviews %}
                <div class="d-flex mb-3">
                  <!-- ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
                  <div class="me-3">
                    {% if review.user.profile.profile_picture %}
                      <img src="{{ review.user.profile.profile_picture.url }}"
                           class="avatar-circle-40"
                           alt="{{ review.user.get_full_name }}">
                    {% else %}
                      <img src="{% static 'images/default_profile.png' %}"
                           class="avatar-circle-40"
                           alt="Default profile">
                    {% endif %}
                  </div>

                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <div>
                        <strong>{{ review.user.first_name }} {{ review.user.last_name }}</strong>
                        <div class="small text-muted">
                          {{ review.created_at|date:"j M Y H:i" }}
                        </div>
                      </div>
                      <div>
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.rating %}
                            <i class="fa-solid fa-star text-warning"></i>
                          {% else %}
                            <i class="fa-regular fa-star text-warning"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>

                    {% if review.comment %}
                      <p class="mb-2 mt-1">{{ review.comment|linebreaksbr }}</p>
                    {% endif %}

                    {% if review.image1 or review.image2 %}
                      <div class="d-flex gap-2 mb-1">
                        {% if review.image1 %}
                          <img src="{{ review.image1.url }}" class="rounded"
                               style="width: 90px; height: 90px; object-fit: cover;">
                        {% endif %}
                        {% if review.image2 %}
                          <img src="{{ review.image2.url }}" class="rounded"
                               style="width: 90px; height: 90px; object-fit: cover;">
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted small mb-0">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
              </p>
            {% endif %}
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- OVERLAY ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå schedule) -->
<div
  id="scheduleModal"
  class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center"
  style="background: rgba(0,0,0,0.35); z-index: 1050;"
>
  <div class="bg-white rounded-4 shadow-lg p-4"
       style="max-width: 780px; width: 96%; max-height: 90vh; overflow-y: auto; position: relative;">

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î -->
    <button
      type="button"
      class="btn-close position-absolute"
      style="top: 14px; right: 18px;"
      id="closeScheduleBtn"
      aria-label="Close"
    ></button>

    <!-- ‡∏´‡∏±‡∏ß‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ -->
    <div class="d-flex align-items-center mb-3">
      <button
        type="button"
        class="btn btn-link text-dark p-0 me-2"
        id="closeScheduleBack"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h5 class="fw-bold mb-0">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
    </div>

    {% if post.schedule %}
      <!-- ‡∏ñ‡πâ‡∏≤ schedule ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà -->
      <div class="mb-3 text-center">
        <img
          src="{{ post.schedule.url }}"
          alt="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"
          class="img-fluid rounded"
        />
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ -->
      <div class="text-center mt-2">
        <a href="{{ post.schedule.url }}" class="btn btn-outline-secondary btn-sm" download>
          ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
        </a>
      </div>
    {% else %}
      <p class="text-muted small mb-0">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
      </p>
    {% endif %}
  </div>
</div>

{# MODAL: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡πÉ‡∏ä‡πâ Bootstrap modal ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô #}
<div class="modal fade" id="registrantModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 rounded-4">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title fw-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body pt-0">
        <div class="text-muted small mb-2">
          ‡∏£‡∏ß‡∏° {{ post.registrations.count }} ‡∏Ñ‡∏ô
        </div>

        {% if post.registrations.count %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" style="width: 60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                  <th scope="col">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th scope="col">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>

                  {% if user.is_authenticated and user == post.organizer %}
                    <th scope="col">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th>
                    <th scope="col">‡πÄ‡∏û‡∏®</th>
                    <th scope="col">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                    <th scope="col">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                    <th scope="col">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                    <th scope="col">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                    <th scope="col">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                    <th scope="col">‡πÅ‡∏û‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                    <th scope="col">‡πÅ‡∏û‡πâ‡∏¢‡∏≤</th>
                    <th scope="col">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for reg in post.registrations.all %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ reg.prefix }} {{ reg.first_name }} {{ reg.last_name }}</td>
                    <td>{{ reg.user.profile.nickname|default_if_none:"-"|default:"-" }}</td>

                    {% if user.is_authenticated and user == post.organizer %}
                      <td>{{ reg.birth_date|date:"d/m/Y" }}</td>
                      <td>{{ reg.gender }}</td>
                      <td>{{ reg.current_address }}</td>
                      <td>{{ reg.phone }}</td>
                      <td>{{ reg.email }}</td>
                      <td>{{ reg.contact_channel }}</td>
                      <td>{{ reg.chronic_disease|default:"-" }}</td>
                      <td>{{ reg.food_allergy|default:"-" }}</td>
                      <td>{{ reg.drug_allergy|default:"-" }}</td>
                      <td>{{ reg.field_ability }}</td>
                    {% endif %}
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="14" class="text-center text-muted">
                      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted small mb-0">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const openScheduleBtn   = document.getElementById('openScheduleBtn');
  const scheduleModal     = document.getElementById('scheduleModal');
  const closeScheduleBtn  = document.getElementById('closeScheduleBtn');
  const closeScheduleBack = document.getElementById('closeScheduleBack');

  function openSchedule() {
    scheduleModal.classList.remove('d-none');
    scheduleModal.classList.add('d-flex');
  }
  function closeSchedule() {
    scheduleModal.classList.add('d-none');
    scheduleModal.classList.remove('d-flex');
  }

  if (openScheduleBtn && scheduleModal) {
    openScheduleBtn.addEventListener('click', openSchedule);
  }
  if (closeScheduleBtn) {
    closeScheduleBtn.addEventListener('click', closeSchedule);
  }
  if (closeScheduleBack) {
    closeScheduleBack.addEventListener('click', closeSchedule);
  }
  if (scheduleModal) {
    scheduleModal.addEventListener('click', (e) => {
      if (e.target === scheduleModal) {
        closeSchedule();
      }
    });
  }

  // LIKE
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/post/${id}/toggle-like/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': window.CSRF_TOKEN },
      });
      if (!res.ok) return;
      const data = await res.json();
      const icon = document.getElementById(`like-icon-${id}`);
      icon.className = data.liked
        ? 'fas fa-heart fs-5 text-danger'
        : 'far fa-heart fs-5';
    });
  });

  // SAVE
  document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/post/${id}/toggle-save/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': window.CSRF_TOKEN },
      });
      if (!res.ok) return;
      const data = await res.json();
      const icon = document.getElementById(`save-icon-${id}`);
      icon.className = data.saved
        ? 'fas fa-bookmark fs-5 text-primary'
        : 'far fa-bookmark fs-5';
    });
  });
});
</script>
{% endblock %}
