{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  .avatar-circle-40 {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    display: block;
  }

  #registrantModal .modal-dialog { max-width: 1100px; }
  #registrantModal .table-responsive { max-height: 60vh; }
  #registrantModal thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 1;
  }
  #registrantModal .table th,
  #registrantModal .table td {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  .hide-comment-on-this-page { display: none !important; }

  .pill {
    border-radius: 999px;
    padding: .45rem 1rem;
    font-weight: 600;
    font-size: .95rem;
  }
</style>

<div class="container-fluid px-4 mt-3">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <a href="{% url 'home:home' %}" class="text-decoration-none text-dark d-inline-flex align-items-center mb-3">
        <i class="fa-solid fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </a>

      <div class="bg-white shadow-sm rounded-4 overflow-hidden position-relative">

        {% if post.image %}
        <div class="w-100" style="max-height: 340px; overflow: hidden;">
          <img
            src="{{ post.image.url }}"
            alt="{{ post.title }}"
            class="w-100"
            style="object-fit: cover;"
          />
        </div>
        {% endif %}

        <div class="p-4">

          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="pe-3">
              <h3 class="fw-bold mb-2">{{ post.title }}</h3>
              <p class="mb-1 text-muted">
                üìÖ {{ post.event_date|date:"j F Y" }}
              </p>
              <p class="mb-1 text-muted">
                üìç {{ post.location }}
              </p>
            </div>

            <div class="text-end">
              <div class="d-flex align-items-center justify-content-end mb-1">
                {% if post.organizer.profile.profile_picture %}
                  <img
                    src="{{ post.organizer.profile.profile_picture.url }}"
                    class="avatar-circle-40 me-2"
                    alt="{{ post.organizer.get_full_name }}"
                  />
                {% else %}
                  <img
                    src="/media/profile_pics/default.webp"
                    class="avatar-circle-40 me-2"
                    alt="Default profile"
                  />
                {% endif %}
                <div class="text-start">
                  <div class="fw-semibold">{{ post.organizer.first_name }} {{ post.organizer.last_name }}</div>
                  <small class="text-muted">{{ post.created_at|date:"d M Y" }}</small>
                </div>
              </div>

              {# ‚úÖ ‡πÉ‡∏ä‡πâ active_reg_count / is_full ‡∏à‡∏≤‡∏Å view #}
              <div class="small text-muted">
                ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö {{ active_reg_count }}/
                {% if post.slots_available == 0 %}
                  ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
                {% else %}
                  {{ post.slots_available }}
                {% endif %}

                {% if active_reg_count > 0 %}
                  <button
                    type="button"
                    class="btn btn-link btn-sm p-0 ms-2 align-baseline"
                    data-bs-toggle="modal"
                    data-bs-target="#registrantModal"
                  >
                    ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ({{ active_reg_count }})
                  </button>
                {% endif %}
              </div>

              {% if is_full %}
                <div class="mt-1">
                  <span class="badge bg-danger">‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
              {% endif %}
              {% if not post.allow_register %}
                <div class="mt-1">
                  <span class="badge bg-secondary">‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                </div>
              {% endif %}
            </div>
          </div>

          <div class="mb-3">
            <p class="mb-0">
              {{ post.description|linebreaksbr }}
            </p>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3 small text-muted">
            <span>
              {% if post.fee %}
                ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: {{ post.fee }} ‡∏ö‡∏≤‡∏ó
              {% else %}
                ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
              {% endif %}
            </span>
            <span>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {{ post.category }}</span>
          </div>

          <a href="{% url 'chat:activity_chat' post.id %}"
            class="btn btn-outline-primary rounded-pill px-4 fw-semibold">
            ‡πÅ‡∏ä‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
          </a>

          <div class="d-flex justify-content-between align-items-center mt-2">

            <button
              type="button"
              class="btn btn-link text-dark p-0 d-inline-flex align-items-center"
              id="openScheduleBtn"
            >
              <i class="fa-regular fa-file-lines me-2" style="color:#2563eb;"></i> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
            </button>

            <div class="d-flex align-items-center gap-3">

              {% if user.is_authenticated %}
              <button
                type="button"
                class="btn btn-link p-0 like-btn"
                data-id="{{ post.id }}"
                aria-label="like"
              >
                {% if user in post.likes.all %}
                  <i id="like-icon-{{ post.id }}" class="fas fa-heart fs-5 text-danger"></i>
                {% else %}
                  <i id="like-icon-{{ post.id }}" class="far fa-heart fs-5"></i>
                {% endif %}
              </button>

              <a href="#comments" class="text-dark hide-comment-on-this-page" aria-label="comments">
                <i class="fa-regular fa-comment fs-5"></i>
              </a>

              <button
                type="button"
                class="btn btn-link p-0 save-btn"
                data-id="{{ post.id }}"
                aria-label="save"
              >
                {% if user in post.saves.all %}
                  <i id="save-icon-{{ post.id }}" class="fas fa-bookmark fs-5 text-primary"></i>
                {% else %}
                  <i id="save-icon-{{ post.id }}" class="far fa-bookmark fs-5"></i>
                {% endif %}
              </button>
              {% endif %}

              {# ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏±‡∏Ñ‡∏£ #}
              {% if user.is_authenticated %}
                {% if my_reg and my_reg.status == "ACTIVE" %}
                  <span class="badge bg-success">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>

                  <button
                    type="button"
                    class="btn btn-outline-danger rounded-pill px-4 fw-semibold"
                    data-bs-toggle="modal"
                    data-bs-target="#cancelModal"
                  >
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                  </button>

                {% elif my_reg and my_reg.status == "CANCEL_PENDING" %}
                  <span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                  <span id="cancelCountdown" class="badge bg-dark text-white ms-1"></span>

                  <form method="post" action="{% url 'activity_register:undo_cancel_activity' post.id %}" class="d-inline" id="undoCancelForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning rounded-pill px-4 fw-semibold" id="undoCancelBtn">
                      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Undo)
                    </button>
                  </form>

                {% elif my_reg and my_reg.status == "CANCELED" %}
                  <span class="badge bg-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                  {% if cooldown_until_iso %}
                    <span class="text-muted small ms-2">
                      <i class="fa-solid fa-clock me-1"></i>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å
                      <span id="cooldownCountdown" class="fw-semibold text-danger"></span>
                    </span>
                  {% endif %}

                {% else %}
                  {% if post.allow_register and not is_full %}
                    <a
                      href="{% url 'activity_register:register_activity' post.id %}"
                      class="btn btn-success rounded-pill px-4 fw-semibold"
                    >
                      ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    </a>
                  {% elif is_full %}
                    <button type="button" class="btn btn-secondary rounded-pill px-4 fw-semibold" disabled>
                      ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                  {% else %}
                    <button type="button" class="btn btn-secondary rounded-pill px-4 fw-semibold" disabled>
                      ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                  {% endif %}
                {% endif %}
              {% else %}
                {% if post.allow_register and not is_full %}
                  <a
                    href="{% url 'activity_register:register_activity' post.id %}"
                    class="btn btn-success rounded-pill px-4 fw-semibold"
                  >
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                  </a>
                {% endif %}
              {% endif %}
            </div>
          </div>

          <div id="comments" class="mt-4 border-top pt-3">
            <h6 class="fw-bold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h6>

            {% if review_count > 0 %}
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  {% for i in "12345" %}
                    {% if forloop.counter <= avg_rating_int %}
                      <i class="fa-solid fa-star text-warning"></i>
                    {% else %}
                      <i class="fa-regular fa-star text-warning"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <div class="small text-muted">
                  ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ {{ avg_rating|floatformat:1 }} ‡∏à‡∏≤‡∏Å {{ review_count }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                </div>
              </div>

              {% for review in reviews %}
                <div class="d-flex mb-3">
                  <div class="me-3">
                    {% if review.user.profile.profile_picture %}
                      <img src="{{ review.user.profile.profile_picture.url }}"
                           class="avatar-circle-40"
                           alt="{{ review.user.get_full_name }}">
                    {% else %}
                      <img src="/media/profile_pics/default.webp"
                           class="avatar-circle-40"
                           alt="Default profile">
                    {% endif %}
                  </div>

                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <div>
                        <strong>{{ review.user.first_name }} {{ review.user.last_name }}</strong>
                        <div class="small text-muted">
                          {{ review.created_at|date:"j M Y H:i" }}
                        </div>
                      </div>
                      <div>
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.rating %}
                            <i class="fa-solid fa-star text-warning"></i>
                          {% else %}
                            <i class="fa-regular fa-star text-warning"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>

                    {% if review.comment %}
                      <p class="mb-2 mt-1">{{ review.comment|linebreaksbr }}</p>
                    {% endif %}

                    {% if review.image1 or review.image2 %}
                      <div class="d-flex gap-2 mb-1">
                        {% if review.image1 %}
                          <img src="{{ review.image1.url }}" class="rounded"
                               style="width: 90px; height: 90px; object-fit: cover;">
                        {% endif %}
                        {% if review.image2 %}
                          <img src="{{ review.image2.url }}" class="rounded"
                               style="width: 90px; height: 90px; object-fit: cover;">
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted small mb-0">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
              </p>
            {% endif %}
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

{# ‚úÖ Modal ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•) #}
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title fw-semibold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body pt-0">
        <div class="small text-muted mb-2">
          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ)
        </div>

        <form method="post" action="{% url 'activity_register:cancel_activity' post.id %}" id="cancelForm">
          {% csrf_token %}

          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="reason" id="reason1" value="NOT_AVAILABLE" required>
            <label class="form-check-label" for="reason1">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÅ‡∏•‡πâ‡∏ß</label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="reason" id="reason2" value="HEALTH" required>
            <label class="form-check-label" for="reason2">‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡∏ô‡∏´‡∏±‡∏ô</label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="reason" id="reason3" value="OTHER" required>
            <label class="form-check-label" for="reason3">‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡∏£‡∏∞‡∏ö‡∏∏</label>
          </div>

          <div class="mb-3">
            <input type="text" class="form-control" name="other" id="cancelOther" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ)">
            <div class="form-text">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏≠‡∏∑‡πà‡∏ô‡πÜ‚Äù ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ</div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button type="submit" class="btn btn-danger rounded-pill px-4 fw-semibold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAY ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ -->
<div
  id="scheduleModal"
  class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center"
  style="background: rgba(0,0,0,0.35); z-index: 1050;"
>
  <div class="bg-white rounded-4 shadow-lg p-4"
       style="max-width: 780px; width: 96%; max-height: 90vh; overflow-y: auto; position: relative;">

    <button
      type="button"
      class="btn-close position-absolute"
      style="top: 14px; right: 18px;"
      id="closeScheduleBtn"
      aria-label="Close"
    ></button>

    <div class="d-flex align-items-center mb-3">
      <button
        type="button"
        class="btn btn-link text-dark p-0 me-2"
        id="closeScheduleBack"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h5 class="fw-bold mb-0">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
    </div>

    {% if post.schedule %}
      <div class="mb-3" style="background: #e8f4fd; border: 1px solid #b8daff; border-radius: 14px; padding: 1.5rem;">
        <div class="text-center">
          <img
            src="{{ post.schedule.url }}"
            alt="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"
            class="img-fluid rounded"
          />
        </div>

        <div class="text-center mt-3">
          <a href="{{ post.schedule.url }}" class="btn btn-primary btn-sm rounded-pill px-4" download>
            <i class="fa-solid fa-download me-1"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
          </a>
        </div>
      </div>
    {% else %}
      <p class="text-muted small mb-0">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
      </p>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="registrantModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 rounded-4">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title fw-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body pt-0">
        <div class="text-muted small mb-2">
          ‡∏£‡∏ß‡∏° {{ active_reg_count }} ‡∏Ñ‡∏ô
        </div>

        {% if active_reg_count %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" style="width: 60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                  <th scope="col">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th scope="col">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>

                  {% if user.is_authenticated and user == post.organizer %}
                    <th scope="col">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th>
                    <th scope="col">‡πÄ‡∏û‡∏®</th>
                    <th scope="col">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                    <th scope="col">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                    <th scope="col">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                    <th scope="col">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                    <th scope="col">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                    <th scope="col">‡πÅ‡∏û‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                    <th scope="col">‡πÅ‡∏û‡πâ‡∏¢‡∏≤</th>
                    <th scope="col">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for reg in post.registrations.all %}
                  {% if reg.status == "ACTIVE" %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{ reg.prefix }} {{ reg.first_name }} {{ reg.last_name }}</td>
                      <td>{{ reg.user.profile.nickname|default_if_none:"-"|default:"-" }}</td>

                      {% if user.is_authenticated and user == post.organizer %}
                        <td>{{ reg.birth_date|date:"d/m/Y" }}</td>
                        <td>{{ reg.gender }}</td>
                        <td>{{ reg.current_address }}</td>
                        <td>{{ reg.phone }}</td>
                        <td>{{ reg.email }}</td>
                        <td>{{ reg.contact_channel }}</td>
                        <td>{{ reg.chronic_disease|default:"-" }}</td>
                        <td>{{ reg.food_allergy|default:"-" }}</td>
                        <td>{{ reg.drug_allergy|default:"-" }}</td>
                        <td>{{ reg.field_ability }}</td>
                      {% endif %}
                    </tr>
                  {% endif %}
                {% empty %}
                  <tr>
                    <td colspan="14" class="text-center text-muted">
                      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted small mb-0">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const openScheduleBtn   = document.getElementById('openScheduleBtn');
  const scheduleModal     = document.getElementById('scheduleModal');
  const closeScheduleBtn  = document.getElementById('closeScheduleBtn');
  const closeScheduleBack = document.getElementById('closeScheduleBack');

  function openSchedule() {
    scheduleModal.classList.remove('d-none');
    scheduleModal.classList.add('d-flex');
  }
  function closeSchedule() {
    scheduleModal.classList.add('d-none');
    scheduleModal.classList.remove('d-flex');
  }

  if (openScheduleBtn && scheduleModal) openScheduleBtn.addEventListener('click', openSchedule);
  if (closeScheduleBtn) closeScheduleBtn.addEventListener('click', closeSchedule);
  if (closeScheduleBack) closeScheduleBack.addEventListener('click', closeSchedule);
  if (scheduleModal) {
    scheduleModal.addEventListener('click', (e) => {
      if (e.target === scheduleModal) closeSchedule();
    });
  }

  // LIKE
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/post/${id}/toggle-like/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': window.CSRF_TOKEN },
      });
      if (!res.ok) return;
      const data = await res.json();
      const icon = document.getElementById(`like-icon-${id}`);
      icon.className = data.liked
        ? 'fas fa-heart fs-5 text-danger'
        : 'far fa-heart fs-5';
    });
  });

  // SAVE
  document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/post/${id}/toggle-save/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': window.CSRF_TOKEN },
      });
      if (!res.ok) return;
      const data = await res.json();
      const icon = document.getElementById(`save-icon-${id}`);
      icon.className = data.saved
        ? 'fas fa-bookmark fs-5 text-primary'
        : 'far fa-bookmark fs-5';
    });
  });

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OTHER ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å other -> ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á (‡∏ä‡πà‡∏ß‡∏¢ UX ‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö logic backend)
  const cancelForm = document.getElementById('cancelForm');
  if (cancelForm) {
    cancelForm.addEventListener('submit', function(e) {
      const otherRadio = document.getElementById('reason3');
      const otherInput = document.getElementById('cancelOther');
      if (otherRadio && otherRadio.checked && otherInput && !otherInput.value.trim()) {
        e.preventDefault();
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)');
      }
    });
  }

  // ‚úÖ Countdown 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö undo ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  const cancelUndoUntilISO = "{{ cancel_undo_until_iso|escapejs }}";
  if (cancelUndoUntilISO) {
    const deadline = new Date(cancelUndoUntilISO).getTime();
    const countdownEl = document.getElementById('cancelCountdown');
    const undoBtn = document.getElementById('undoCancelBtn');
    const undoForm = document.getElementById('undoCancelForm');

    function updateCountdown() {
      const now = Date.now();
      const diff = deadline - now;

      if (diff <= 0) {
        if (countdownEl) countdownEl.textContent = '00:00';
        if (undoBtn) { undoBtn.disabled = true; undoBtn.textContent = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤'; }
        setTimeout(() => location.reload(), 1200);
        return;
      }

      const mins = Math.floor(diff / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      if (countdownEl) {
        countdownEl.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
      }
      requestAnimationFrame(() => setTimeout(updateCountdown, 250));
    }
    updateCountdown();
  }

  // ‚úÖ Cooldown countdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CANCELED (‡∏£‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà)
  const cooldownUntilISO = "{{ cooldown_until_iso|escapejs }}";
  if (cooldownUntilISO) {
    const cdDeadline = new Date(cooldownUntilISO).getTime();
    const cdEl = document.getElementById('cooldownCountdown');

    function updateCooldown() {
      const now = Date.now();
      const diff = cdDeadline - now;

      if (diff <= 0) {
        if (cdEl) cdEl.textContent = '';
        setTimeout(() => location.reload(), 1000);
        return;
      }

      const hrs = Math.floor(diff / 3600000);
      const mins = Math.floor((diff % 3600000) / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      if (cdEl) {
        cdEl.textContent = (hrs > 0 ? hrs + ' ‡∏ä‡∏°. ' : '') + mins + ' ‡∏ô‡∏≤‡∏ó‡∏µ ' + secs + ' ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ';
      }
      requestAnimationFrame(() => setTimeout(updateCooldown, 500));
    }
    updateCooldown();
  }
});
</script>
{% endblock %}
